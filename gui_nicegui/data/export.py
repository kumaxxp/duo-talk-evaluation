"""Export utilities for demo pack results.

Creates zip archives of run results.
"""

import json
import zipfile
from pathlib import Path


# Files to include in export
EXPORT_FILES = [
    "REPORT.md",
    "CONVERSATION_REPORT.md",
    "turns_log.json",
    "result.json",
    "examples_index.csv",
]


def collect_export_files(run_dir: Path) -> list[Path]:
    """Collect files for export from run directory.

    Args:
        run_dir: Run directory path

    Returns:
        List of file paths to include in export
    """
    files: list[Path] = []

    # Add main files
    for filename in EXPORT_FILES:
        file_path = run_dir / filename
        if file_path.exists():
            files.append(file_path)

    # Add artifacts directory contents
    artifacts_dir = run_dir / "artifacts"
    if artifacts_dir.exists() and artifacts_dir.is_dir():
        for artifact in artifacts_dir.iterdir():
            if artifact.is_file():
                files.append(artifact)

    return files


def generate_export_readme(run_info: dict) -> str:
    """Generate README for export.

    Args:
        run_info: Run information dictionary

    Returns:
        README content string
    """
    scenario_id = run_info.get("scenario_id", "unknown")
    profile = run_info.get("profile", "unknown")
    total_turns = run_info.get("total_turns", 0)
    give_up_count = run_info.get("give_up_count", 0)
    retry_count = run_info.get("retry_count", 0)
    timestamp = run_info.get("timestamp", "unknown")

    return f"""# duo-talk Evaluation Export

## 実行情報

| 項目 | 値 |
|------|-----|
| シナリオ | {scenario_id} |
| プロファイル | {profile} |
| 総ターン数 | {total_turns} |
| GiveUp数 | {give_up_count} |
| リトライ数 | {retry_count} |
| 実行日時 | {timestamp} |

## ファイル構成

- `REPORT.md` - 実行レポート
- `CONVERSATION_REPORT.md` - 会話レポート
- `turns_log.json` - ターン詳細ログ
- `result.json` - 結果メタデータ
- `artifacts/` - ターン別アーティファクト

## 使い方

### 結果の確認

```bash
# レポートを見る
cat REPORT.md

# ターンログをjqで解析
jq '.[] | select(.give_up == true)' turns_log.json
```

### 同じシナリオをPlay Modeで探索

```bash
make play s={scenario_id}
```

## 再現方法

```bash
# duo-talk-evaluationリポジトリで
python experiments/gm_2x2_runner.py \\
    --scenarios {scenario_id} \\
    --profile {profile}
```

---

*Generated by duo-talk-evaluation*
"""


def create_export_zip(
    run_dir: Path,
    output_path: Path,
    include_readme: bool = False,
) -> None:
    """Create zip file with run results.

    Args:
        run_dir: Run directory to export
        output_path: Output zip file path
        include_readme: If True, include generated README
    """
    files = collect_export_files(run_dir)

    with zipfile.ZipFile(output_path, "w", zipfile.ZIP_DEFLATED) as zipf:
        for file_path in files:
            # Use relative path within zip
            arcname = file_path.relative_to(run_dir)
            zipf.write(file_path, arcname)

        # Add README if requested
        if include_readme:
            # Try to load run info from result.json
            result_file = run_dir / "result.json"
            if result_file.exists():
                run_info = json.loads(result_file.read_text(encoding="utf-8"))
            else:
                run_info = {"scenario_id": run_dir.name}

            readme_content = generate_export_readme(run_info)
            zipf.writestr("README.md", readme_content)


def create_pack_export_zip(
    pack_dir: Path,
    scenario_dirs: list[Path],
    output_path: Path,
) -> None:
    """Create zip file for entire demo pack.

    Args:
        pack_dir: Pack run directory
        scenario_dirs: List of scenario run directories
        output_path: Output zip file path
    """
    with zipfile.ZipFile(output_path, "w", zipfile.ZIP_DEFLATED) as zipf:
        for scenario_dir in scenario_dirs:
            files = collect_export_files(scenario_dir)
            for file_path in files:
                # Include scenario name in path
                arcname = scenario_dir.name / file_path.relative_to(scenario_dir)
                zipf.write(file_path, arcname)
