From 43a8877ebf93808c208b81279ed25022689bf644 Mon Sep 17 00:00:00 2001
From: kumaxxp <xxp@ezweb.ne.jp>
Date: Mon, 26 Jan 2026 14:51:36 +0900
Subject: [PATCH] =?UTF-8?q?feat(P-Next1/PR2):=20Play=20Mode=E5=B0=8E?=
 =?UTF-8?q?=E7=B7=9A=E7=9F=AD=E7=B8=AE=20-=20=E3=82=A8=E3=82=A4=E3=83=AA?=
 =?UTF-8?q?=E3=82=A2=E3=82=B9=E5=BC=B7=E5=8C=96=20&=20=E3=83=98=E3=83=AB?=
 =?UTF-8?q?=E3=83=97=E6=94=B9=E5=96=84?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

## å¤‰æ›´å†…å®¹

### çŸ­ç¸®ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¿½åŠ 
- g = move (go)
- t = take
- o = open
- x = search (examine)
- æ—¥æœ¬èªã‚¨ã‚¤ãƒªã‚¢ã‚¹æ‹¡å…… (è¡Œã, æ‹¾ã†, é–‹ã, æ¢ã™ç­‰)

### ãƒ˜ãƒ«ãƒ—æ”¹å–„
- ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ (æ¢ç´¢/ã‚¢ã‚¤ãƒ†ãƒ /æƒ…å ±/ã‚·ã‚¹ãƒ†ãƒ )
- å…¨ã‚¨ã‚¤ãƒªã‚¢ã‚¹è¡¨ç¤º
- ä½¿ç”¨ä¾‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ 

### ã‚³ãƒãƒ³ãƒ‰ææ¡ˆæ©Ÿèƒ½
- ã‚¿ã‚¤ãƒæ™‚ã«é¡ä¼¼ã‚³ãƒãƒ³ãƒ‰ã‚’ææ¡ˆ
- suggest_command() é–¢æ•°è¿½åŠ 

### èµ·å‹•ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ”¹å–„
- ã‚¯ã‚¤ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹è¡¨ç¤º
- è¦–èªæ€§å‘ä¸Šã®ãŸã‚ã®ç½«ç·šè¿½åŠ 

## ãƒ†ã‚¹ãƒˆ
- TestShortAliases: 5ãƒ†ã‚¹ãƒˆè¿½åŠ 
- TestSuggestCommand: 4ãƒ†ã‚¹ãƒˆè¿½åŠ 
- TestImprovedHelp: 3ãƒ†ã‚¹ãƒˆè¿½åŠ 
- TestCommandAliasesDictionary: 3ãƒ†ã‚¹ãƒˆè¿½åŠ 
- åˆè¨ˆ49ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹
---
 scripts/play_mode.py    | 149 +++++++++++++++++++++++++----------
 tests/test_play_mode.py | 167 ++++++++++++++++++++++++++++++++++++++++
 2 files changed, 277 insertions(+), 39 deletions(-)

diff --git a/scripts/play_mode.py b/scripts/play_mode.py
index 4a30128..0162059 100644
--- a/scripts/play_mode.py
+++ b/scripts/play_mode.py
@@ -149,6 +149,22 @@ def format_character_status(positions: dict[str, str]) -> str:
 # =============================================================================
 
 
+# Command aliases for quick reference
+COMMAND_ALIASES: dict[str, list[str]] = {
+    "look": ["look", "l", "è¦‹ã‚‹", "look around"],
+    "move": ["move", "go", "g", "ç§»å‹•", "è¡Œã"],
+    "take": ["take", "get", "t", "å–ã‚‹", "æ‹¾ã†"],
+    "open": ["open", "o", "é–‹ã‘ã‚‹", "é–‹ã"],
+    "search": ["search", "inspect", "x", "examine", "èª¿ã¹ã‚‹", "æ¢ã™"],
+    "where": ["where", "w", "ã©ã“", "ç¾åœ¨åœ°"],
+    "inventory": ["inventory", "inv", "i", "æŒã¡ç‰©", "æ‰€æŒå“"],
+    "map": ["map", "m", "åœ°å›³", "ãƒãƒƒãƒ—"],
+    "help": ["help", "h", "?", "ãƒ˜ãƒ«ãƒ—"],
+    "quit": ["quit", "exit", "q", "çµ‚äº†"],
+    "status": ["status", "st", "çŠ¶æ…‹", "ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"],
+}
+
+
 def parse_command(user_input: str) -> ParsedCommand:
     """Parse user input into command.
 
@@ -166,31 +182,62 @@ def parse_command(user_input: str) -> ParsedCommand:
     action = parts[0].lower()
     target = parts[1] if len(parts) > 1 else None
 
-    # Normalize commands
-    if action in ("look", "l", "è¦‹ã‚‹"):
-        return ParsedCommand(action="look", target=target)
-    elif action in ("move", "go", "ç§»å‹•"):
-        return ParsedCommand(action="move", target=target)
-    elif action in ("take", "get", "å–ã‚‹"):
-        return ParsedCommand(action="take", target=target)
-    elif action in ("open", "é–‹ã‘ã‚‹"):
-        return ParsedCommand(action="open", target=target)
-    elif action in ("search", "inspect", "èª¿ã¹ã‚‹"):
-        return ParsedCommand(action="search", target=target)
-    elif action in ("where", "w", "ã©ã“"):
-        return ParsedCommand(action="where", target=None)
-    elif action in ("inventory", "inv", "i", "æŒã¡ç‰©"):
-        return ParsedCommand(action="inventory", target=None)
-    elif action in ("map", "m", "åœ°å›³"):
-        return ParsedCommand(action="map", target=None)
-    elif action in ("help", "h", "?"):
-        return ParsedCommand(action="help", target=None)
-    elif action in ("quit", "exit", "q"):
-        return ParsedCommand(action="quit", target=None)
-    elif action in ("status", "st", "çŠ¶æ…‹"):
-        return ParsedCommand(action="status", target=None)
-    else:
-        return ParsedCommand(action="unknown", target=user_input)
+    # Normalize commands using alias dictionary
+    for cmd, aliases in COMMAND_ALIASES.items():
+        if action in aliases:
+            # where, inventory, map, help, quit, status don't use targets
+            if cmd in ("where", "inventory", "map", "help", "quit", "status"):
+                return ParsedCommand(action=cmd, target=None)
+            return ParsedCommand(action=cmd, target=target)
+
+    return ParsedCommand(action="unknown", target=user_input)
+
+
+def suggest_command(user_input: str) -> str | None:
+    """Suggest a similar command for typos or unknown input.
+
+    Args:
+        user_input: The unknown user input
+
+    Returns:
+        Suggestion message or None if no good match
+    """
+    if not user_input:
+        return None
+
+    action = user_input.split()[0].lower()
+
+    # Common typos and suggestions
+    suggestions: dict[str, str] = {
+        "lok": "look",
+        "loo": "look",
+        "mve": "move",
+        "mov": "move",
+        "tke": "take",
+        "tak": "take",
+        "opn": "open",
+        "serch": "search",
+        "srch": "search",
+        "wher": "where",
+        "invent": "inventory",
+        "invetory": "inventory",
+        "mp": "map",
+        "hlp": "help",
+        "hep": "help",
+        "ext": "quit",
+        "exi": "quit",
+    }
+
+    if action in suggestions:
+        return f"ã‚‚ã—ã‹ã—ã¦: {suggestions[action]}"
+
+    # Check if it starts like a known command
+    for cmd, aliases in COMMAND_ALIASES.items():
+        for alias in aliases:
+            if len(action) >= 2 and alias.startswith(action):
+                return f"ã‚‚ã—ã‹ã—ã¦: {alias}"
+
+    return None
 
 
 def get_help_text() -> str:
@@ -200,18 +247,34 @@ def get_help_text() -> str:
         Help text string
     """
     return """
-ğŸ“– ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§:
-  look, l           - ç¾åœ¨åœ°ã®æƒ…å ±ã‚’è¡¨ç¤º
-  move <å ´æ‰€>       - æŒ‡å®šã—ãŸå ´æ‰€ã«ç§»å‹•
-  take <ç‰©>         - ç‰©ã‚’æ‹¾ã†
-  open <å®¹å™¨>       - å®¹å™¨ã‚’é–‹ã‘ã¦ä¸­èº«ã‚’è¦‹ã‚‹
-  search [å¯¾è±¡]     - éš ã•ã‚ŒãŸã‚‚ã®ã‚’æ¢ã™
-  where, w          - ç¾åœ¨åœ°ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®
-  inventory, inv, i - æ‰€æŒå“ä¸€è¦§
-  map, m            - å…¨ä½“ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
-  status, st        - ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤º
-  help, h           - ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
-  quit, q           - çµ‚äº†
+ğŸ“– ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§
+
+ã€æ¢ç´¢ã€‘
+  look (l)              ç¾åœ¨åœ°ã®æƒ…å ±ã‚’è¡¨ç¤º
+  move <å ´æ‰€> (go, g)   æŒ‡å®šã—ãŸå ´æ‰€ã«ç§»å‹•
+  search [å¯¾è±¡] (x)     éš ã•ã‚ŒãŸã‚‚ã®ã‚’æ¢ã™
+  map (m)               å…¨ä½“ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
+
+ã€ã‚¢ã‚¤ãƒ†ãƒ ã€‘
+  take <ç‰©> (get, t)    ç‰©ã‚’æ‹¾ã†
+  open <å®¹å™¨> (o)       å®¹å™¨ã‚’é–‹ã‘ã¦ä¸­èº«ã‚’è¦‹ã‚‹
+  inventory (inv, i)    æ‰€æŒå“ä¸€è¦§
+
+ã€æƒ…å ±ã€‘
+  where (w)             ç¾åœ¨åœ°ã¨ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ä½ç½®
+  status (st)           ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼çŠ¶æ…‹ã‚’è¡¨ç¤º
+  help (h, ?)           ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
+
+ã€ã‚·ã‚¹ãƒ†ãƒ ã€‘
+  quit (q)              çµ‚äº†
+
+ã€ä½¿ç”¨ä¾‹ã€‘
+  move ãƒªãƒ“ãƒ³ã‚°         ãƒªãƒ“ãƒ³ã‚°ã«ç§»å‹•
+  take ã‚³ãƒ¼ãƒ’ãƒ¼è±†       ã‚³ãƒ¼ãƒ’ãƒ¼è±†ã‚’æ‹¾ã†
+  open å¼•ãå‡ºã—         å¼•ãå‡ºã—ã‚’é–‹ã‘ã‚‹
+  x æœ¬æ£š                æœ¬æ£šã‚’èª¿ã¹ã‚‹
+
+ğŸ’¡ ãƒ’ãƒ³ãƒˆ: æ‹¬å¼§å†…ã¯çœç•¥å½¢ã§ã™ (ä¾‹: l = look)
 """
 
 
@@ -400,7 +463,12 @@ def execute_command(cmd: ParsedCommand, state: PlayState) -> tuple[str, PlayStat
         return "çµ‚äº†ã—ã¾ã™ã€‚", state
 
     else:
-        return f"ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {cmd.get('target', '')}ã€‚'help' ã§ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º", state
+        msg = f"â“ ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: {cmd.get('target', '')}"
+        suggestion = suggest_command(cmd.get("target", ""))
+        if suggestion:
+            msg += f"\nğŸ’¡ {suggestion}"
+        msg += "\nğŸ“– 'help' ã§ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã‚’è¡¨ç¤º"
+        return msg, state
 
 
 # =============================================================================
@@ -421,7 +489,10 @@ def run_play_mode(scenario_path: Path):
         sys.exit(1)
 
     print(f"\nğŸ® Play Mode: {state['scenario_name']}")
-    print("'help' ã§ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§ã€'quit' ã§çµ‚äº†")
+    print("â”€" * 40)
+    print("ğŸ’¡ ã‚¯ã‚¤ãƒƒã‚¯ã‚³ãƒãƒ³ãƒ‰: l=è¦‹ã‚‹ g=ç§»å‹• t=å–ã‚‹ o=é–‹ã‘ã‚‹ x=èª¿ã¹ã‚‹")
+    print("   h=ãƒ˜ãƒ«ãƒ— m=ãƒãƒƒãƒ— i=æ‰€æŒå“ q=çµ‚äº†")
+    print("â”€" * 40)
     print()
     print(format_world_state(state))
     print()
diff --git a/tests/test_play_mode.py b/tests/test_play_mode.py
index 0327b11..59866fa 100644
--- a/tests/test_play_mode.py
+++ b/tests/test_play_mode.py
@@ -573,3 +573,170 @@ class TestHelpUpdatedForNewCommands:
         help_text = get_help_text()
 
         assert "map" in help_text
+
+
+class TestShortAliases:
+    """Tests for short command aliases (P-Next1/PR2)."""
+
+    def test_parse_g_as_move(self):
+        """'g' should be alias for move."""
+        from scripts.play_mode import parse_command
+
+        cmd = parse_command("g ãƒªãƒ“ãƒ³ã‚°")
+        assert cmd["action"] == "move"
+        assert cmd["target"] == "ãƒªãƒ“ãƒ³ã‚°"
+
+    def test_parse_t_as_take(self):
+        """'t' should be alias for take."""
+        from scripts.play_mode import parse_command
+
+        cmd = parse_command("t ã‚³ãƒ¼ãƒ’ãƒ¼è±†")
+        assert cmd["action"] == "take"
+        assert cmd["target"] == "ã‚³ãƒ¼ãƒ’ãƒ¼è±†"
+
+    def test_parse_o_as_open(self):
+        """'o' should be alias for open."""
+        from scripts.play_mode import parse_command
+
+        cmd = parse_command("o å¼•ãå‡ºã—")
+        assert cmd["action"] == "open"
+        assert cmd["target"] == "å¼•ãå‡ºã—"
+
+    def test_parse_x_as_search(self):
+        """'x' should be alias for search (examine)."""
+        from scripts.play_mode import parse_command
+
+        cmd = parse_command("x æœ¬æ£š")
+        assert cmd["action"] == "search"
+        assert cmd["target"] == "æœ¬æ£š"
+
+    def test_parse_examine_as_search(self):
+        """'examine' should be alias for search."""
+        from scripts.play_mode import parse_command
+
+        cmd = parse_command("examine å£")
+        assert cmd["action"] == "search"
+        assert cmd["target"] == "å£"
+
+
+class TestSuggestCommand:
+    """Tests for command suggestion on typos (P-Next1/PR2)."""
+
+    def test_suggest_for_common_typo(self):
+        """Should suggest correct command for common typos."""
+        from scripts.play_mode import suggest_command
+
+        result_lok = suggest_command("lok")
+        result_mov = suggest_command("mov")
+        result_tke = suggest_command("tke")
+
+        assert result_lok is not None and "look" in result_lok
+        assert result_mov is not None and "move" in result_mov
+        assert result_tke is not None and "take" in result_tke
+
+    def test_suggest_for_partial_match(self):
+        """Should suggest command for partial input."""
+        from scripts.play_mode import suggest_command
+
+        # Should match commands starting with partial input
+        result = suggest_command("hel")
+        assert result is not None
+        assert "help" in result
+
+    def test_no_suggestion_for_valid_command(self):
+        """Should return None for unrecognized input without close match."""
+        from scripts.play_mode import suggest_command
+
+        result = suggest_command("xyzabc")
+        assert result is None
+
+    def test_unknown_command_shows_suggestion(self):
+        """Unknown command should show suggestion in output."""
+        from scripts.play_mode import execute_command, PlayState, ParsedCommand
+
+        state = PlayState(
+            scenario_name="test",
+            current_location="ã‚­ãƒƒãƒãƒ³",
+            available_objects=[],
+            available_exits=[],
+            character_positions={},
+            holding=[],
+            scenario_data={},
+        )
+
+        cmd = ParsedCommand(action="unknown", target="lok")
+        output, _ = execute_command(cmd, state)
+
+        assert "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰" in output
+        assert "help" in output
+
+
+class TestImprovedHelp:
+    """Tests for improved help formatting (P-Next1/PR2)."""
+
+    def test_help_has_categories(self):
+        """Help should have category headers."""
+        from scripts.play_mode import get_help_text
+
+        help_text = get_help_text()
+
+        assert "æ¢ç´¢" in help_text
+        assert "ã‚¢ã‚¤ãƒ†ãƒ " in help_text
+        assert "æƒ…å ±" in help_text
+        assert "ã‚·ã‚¹ãƒ†ãƒ " in help_text
+
+    def test_help_shows_aliases(self):
+        """Help should show command aliases."""
+        from scripts.play_mode import get_help_text
+
+        help_text = get_help_text()
+
+        # Check that short aliases are shown
+        assert "(l)" in help_text  # look alias
+        assert "(g)" in help_text or "go, g" in help_text  # move alias
+        assert "(t)" in help_text or "get, t" in help_text  # take alias
+
+    def test_help_has_examples(self):
+        """Help should include usage examples."""
+        from scripts.play_mode import get_help_text
+
+        help_text = get_help_text()
+
+        assert "ä½¿ç”¨ä¾‹" in help_text
+        assert "move ãƒªãƒ“ãƒ³ã‚°" in help_text or "ãƒªãƒ“ãƒ³ã‚°" in help_text
+
+
+class TestCommandAliasesDictionary:
+    """Tests for COMMAND_ALIASES dictionary (P-Next1/PR2)."""
+
+    def test_command_aliases_exists(self):
+        """COMMAND_ALIASES dictionary should exist."""
+        from scripts.play_mode import COMMAND_ALIASES
+
+        assert isinstance(COMMAND_ALIASES, dict)
+        assert "look" in COMMAND_ALIASES
+        assert "move" in COMMAND_ALIASES
+
+    def test_all_commands_have_aliases(self):
+        """All main commands should have aliases defined."""
+        from scripts.play_mode import COMMAND_ALIASES
+
+        expected_commands = [
+            "look", "move", "take", "open", "search",
+            "where", "inventory", "map", "help", "quit", "status"
+        ]
+        for cmd in expected_commands:
+            assert cmd in COMMAND_ALIASES, f"Missing alias for: {cmd}"
+
+    def test_japanese_aliases_included(self):
+        """Japanese aliases should be included."""
+        from scripts.play_mode import COMMAND_ALIASES
+
+        # Check some Japanese aliases exist
+        all_aliases = []
+        for aliases in COMMAND_ALIASES.values():
+            all_aliases.extend(aliases)
+
+        assert "è¦‹ã‚‹" in all_aliases
+        assert "ç§»å‹•" in all_aliases
+        assert "å–ã‚‹" in all_aliases
-- 
2.43.0

