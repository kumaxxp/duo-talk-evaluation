---
name: troubleshoot
description: 問題発生時に機能一覧(docs/機能一覧.md)を参照し、利用可能な機能から解決策を提案する。フォーマット問題、品質問題、パフォーマンス問題、評価問題に対応。
---

# トラブルシュートスキル

プロジェクトで問題が発生した際に、機能一覧を参照して解決策を提案する。

## 使用タイミング

- ユーザーが問題を報告したとき
- 実験結果が期待通りでないとき
- エラーや品質低下が発生したとき
- `/troubleshoot` コマンドを実行したとき

## 実行手順

### 1. 機能一覧を読み込む

まず `docs/機能一覧.md` を読み込み、利用可能な機能を把握する。

```
Read: /home/owner/work/duo-talk-ecosystem/duo-talk-evaluation/docs/機能一覧.md
```

### 2. 問題を分類する

報告された問題を以下のカテゴリに分類:

| カテゴリ | 症状例 | 関連セクション |
|---------|--------|---------------|
| **フォーマット問題** | Thought空、Output不正、名前誤出力 | 1.1, 2.2, 2.3, 3.3 |
| **品質問題** | キャラ崩壊、話題ループ、不自然 | 1.2, 2.1, 2.4 |
| **パフォーマンス問題** | 遅い、リトライ多発 | 2.3, 3.4 |
| **評価問題** | スコア低い、誤検出 | 2.2, 2.3, 2.4 |

### 3. 関連機能を特定する

機能一覧から、問題に関連する機能を抽出:

- **現在有効な機能**: 設定変更で解決可能か
- **利用可能だが無効な機能**: 有効化で解決可能か
- **レガシー機能**: 過去に効果があった機能か

### 4. 解決策を提案する

以下のフォーマットで提案:

```markdown
## 問題分析

**症状**: [ユーザーが報告した問題]
**カテゴリ**: [フォーマット/品質/パフォーマンス/評価]
**原因仮説**: [推定される原因]

## 解決策提案

### 提案1: [機能名] の有効化/変更

**現在の状態**: [有効/無効/設定値]
**推奨変更**: [変更内容]
**期待効果**: [効果の説明]
**効果実績**: [過去の検証結果があれば]

**実装方法**:
```python
# コード例
```

### 提案2: ...

## 優先順位

1. [最も効果が高い/リスクが低い提案]
2. [次の提案]
3. ...

## 検証方法

提案を適用後、以下の方法で効果を検証:
- [検証手順1]
- [検証手順2]
```

## 問題別の推奨機能マッピング

### フォーマット問題

| 症状 | 推奨機能 | 有効化方法 |
|------|---------|-----------|
| Thoughtが空/不正 | `strict_thought_check=True` | DirectorMinimal設定 |
| Thoughtが長すぎる | TWO_PASS + max_tokens=120 | GenerationMode変更 |
| Output形式不正 | v3.6-v3.8フロー | VariationConfig設定 |
| 名前が出力される | v3.7フロー | use_v37_flow=True |

### 品質問題

| 症状 | 推奨機能 | 有効化方法 |
|------|---------|-----------|
| キャラ崩壊 | DirectorHybrid | LLM評価追加 |
| 話題ループ | v2.9.2 Novelty Enforcement | TWO_PASS有効化 |
| AI的な丁寧語 | v2.9.3 Anti-Concierge | TWO_PASS有効化 |
| ヤンデレ現象 | v2.7.1 max_tokens=120 | TWO_PASS有効化 |

### パフォーマンス問題

| 症状 | 推奨機能 | 有効化方法 |
|------|---------|-----------|
| リトライ多発 | 問題の根本原因特定 | ログ分析 |
| LLM評価が遅い | `skip_llm_on_static_retry=True` | DirectorHybrid設定 |
| 全体的に遅い | DirectorMinimal | Hybrid→Minimal変更 |

### 評価問題

| 症状 | 推奨機能 | 有効化方法 |
|------|---------|-----------|
| Thought誤検出 | ToneChecker v2.2 | 最新版確認 |
| スコアが低い | 閾値調整 | ThresholdConfig変更 |
| 評価が厳しすぎる | warn_overall上げる | thresholds.py変更 |

## 出力フォーマット

解決策提案後、以下を報告:

```
🔍 問題分析完了

📋 問題: [問題の要約]
🏷️ カテゴリ: [カテゴリ]

💡 提案:
1. [提案1の要約] - 効果: ⭐⭐⭐
2. [提案2の要約] - 効果: ⭐⭐

🔧 最優先アクション:
[具体的なコード変更または設定変更]

📊 検証コマンド:
```bash
python experiments/director_comparison_test.py --runs 1
```
```

## 使用例

```
ユーザー: Thoughtが空になる問題が頻発しています

Claude: /troubleshoot を実行します。

🔍 問題分析完了

📋 問題: Thoughtが空になる
🏷️ カテゴリ: フォーマット問題

💡 提案:
1. TWO_PASSモード有効化 - 効果: ⭐⭐⭐ (検証済み: 88%減少)
2. strict_thought_check=True確認 - 効果: ⭐⭐⭐

🔧 最優先アクション:
```python
manager = create_dialogue_manager(
    generation_mode=GenerationMode.TWO_PASS,
)
```

📊 検証コマンド:
```bash
python experiments/director_comparison_test.py --runs 1
```
```

## 注意事項

- 複数の問題が絡み合っている場合は、影響範囲の小さいものから解決
- 設定変更後は必ず実験で効果を検証
- 過去の検証結果（効果: ⭐⭐⭐ など）を参考に優先順位を決定
- 機能一覧に記載のない問題は、新規調査が必要
