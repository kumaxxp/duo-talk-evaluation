# Phase 2 v0.3 改善効果分析レポート

**実験ID**: director_ab_20260123_101507
**日時**: 2026-01-23 10:15:07
**分析者**: Claude Code

---

## 1. v0.3改善の概要

Phase 2 v0.3では**ToneChecker v2.1 (Negative Policing)** を実装：

| 改善項目 | 内容 | 目的 |
|----------|------|------|
| **A. ポジティブスコアリング廃止** | マーカー必須判定を削除 | 「Forced Cheerfulness」問題の解消 |
| **B. ネガティブ検知の導入** | 禁止パターンのみを検出 | 自然な発話の許容 |
| **C. 禁止ルール拡充** | やな: です/ます禁止, あゆ: だね/じゃん/スラング禁止 | キャラクター逸脱の防止 |

---

## 2. 実験諸元

| 項目 | 値 |
|------|-----|
| バックエンド | Ollama |
| LLM | gemma3:12b |
| プロンプト構造 | Layered (v3.8.1) |
| RAG | 無効 |
| Director | DirectorMinimal (5チェッカー + **ToneChecker v2.1**) |
| max_retries | 3 |
| シナリオ数 | 3 |
| 実行回数/シナリオ | 2 |
| 総実行数 | 12 (6 without + 6 with Director) |

### ToneChecker v2.1 検出ルール

**やな (Negative Policing):**
```yaml
forbidden_endings:
  - ございます  # 最長優先
  - 致します
  - です
  - ます
forbidden_words:
  - 姉様  # あゆ専用
excessive_exclamation:
  threshold: 3  # 4個以上で WARN
```

**あゆ (Negative Policing):**
```yaml
forbidden_endings:
  - だね
  - だよ
  - じゃん
  - でしょ
forbidden_words:
  - 姉上
  - お姉ちゃん
  - やなちゃん
forbidden_slang:
  - マジ
  - ヤバい
  - うける
```

---

## 3. 定量的結果

### 3.1 全体サマリー

| メトリクス | Director無し | Director有り | 差分 |
|------------|-------------|-------------|------|
| 成功数 | 6/6 | 6/6 | - |
| 総ターン数 | 32 | 32 | - |
| 平均リトライ数 | 0.00 | **0.17** | +0.17 |
| 総不採用数 | 0 | **1** | +1 |

### 3.2 不採用の内訳

| チェッカー | 不採用数 | 割合 | 違反タイプ |
|------------|----------|------|------------|
| tone_check | 1 | 100% | forbidden_ending (だよ) |
| praise_check | 0 | 0% | - |
| context_check | 0 | 0% | - |
| setting_check | 0 | 0% | - |
| format_check | 0 | 0% | - |

### 3.3 シナリオ別不採用数

| シナリオ | 不採用数 | 詳細 |
|----------|----------|------|
| casual_greeting | 0 | リトライなし |
| topic_exploration | 0 | リトライなし |
| emotional_support | 1 | Run1: 1 (あゆが「だよ」を使用) |

---

## 4. v0.2 → v0.3 比較分析

### 4.1 リトライ数の劇的削減

| メトリクス | v0.2 | v0.3 | 改善率 |
|------------|------|------|--------|
| 平均リトライ数 | 1.17 | **0.17** | **-86%** |
| 総不採用数 | 8 | **1** | **-88%** |
| tone_check不採用 | 8 | 1 | **-88%** |

### 4.2 不採用理由の質的変化

**v0.2 (ポジティブスコアリング):**
```
不採用理由: 口調スコア不足 (score=0)
問題: マーカーがないだけで静かな発話もリジェクト
例: 「うん、わかった」→ RETRY (score=0)
```

**v0.3 (ネガティブ検知):**
```
不採用理由: 禁止された語尾「だよ」を使用しました
問題: 明確な規則違反のみをリジェクト
例: 「うん、わかった」→ PASS (違反なし)
```

### 4.3 唯一の不採用ケース分析

**emotional_support シナリオ, Turn 2 (あゆ):**

❌ Attempt 1:
```
Response: *少し顔を赤らめて* 「…まあ、ちょっとね。でも、プロジェクトの進捗もあるから、気をつけてるつもりだよ。」
Status: RETRY
Reason: 役割違反: あなたは「あゆ」（妹 (Younger Sister)）です。禁止された語尾「だよ」を使用しました。
```

✅ Retry後:
```
Response: *少し顔を赤らめて* 「はい…少しだけ。でも、姉様のおかげでなんとかやってます…ありがとうね。」
Status: PASS
```

**分析:**
- v0.3のネガティブ検知が正しく機能
- あゆは丁寧語キャラなので「だよ」は確かにキャラ逸脱
- リトライ後は適切な「～ね。」で終了
- Directorの判断は妥当

---

## 5. 期待効果の検証

### 5.1 リトライ率の最適化 ✅ 達成

| 検証項目 | 期待 | 結果 |
|----------|------|------|
| 「うん、わかった」のような中立応答 | PASS | **PASS** |
| 口調スコア0でもマーカー不足だけ | PASS | **PASS** |
| 明確な禁止語尾（です/ます/だよ等） | RETRY | **RETRY** |

### 5.2 キャラクターの深度向上 ✅ 達成

v0.3の会話サンプルでは、「！」を使わない落ち着いた表現も採用されている：

```
やな: (心配そうに顔を覗き込んで) 「え？最近、疲れてるんだ…。大丈夫？ あゆ、ちゃんと寝てる？ 顔色も悪いみたいだし…」
→ 感嘆符なし、落ち着いたトーン → PASS
```

### 5.3 不自然さの解消 ✅ 達成

v0.2で問題だった「Forced Cheerfulness」（強制された元気さ）が解消：

| v0.2 | v0.3 |
|------|------|
| マーカーがないと即RETRY | 違反がなければPASS |
| 「！」を入れないとスコア不足 | 「！」なしでも問題なし |
| 静かな心配の表現がリジェクト | 自然に採用 |

---

## 6. テストカバレッジ

```
======================== tests coverage ================================
Name                                            Stmts   Miss  Cover
----------------------------------------------------------------------
src/duo_talk_director/checks/tone_check.py        79      4    95%
src/duo_talk_director/director_minimal.py         51      3    93%
----------------------------------------------------------------------
TOTAL                                            258     12    95%
```

- **全テスト**: 109件成功 (1件スキップ)
- **カバレッジ**: 95% (目標80%以上)
- **v2.1専用テスト**: 27件新規追加

---

## 7. 結論

### 成功した改善

1. **リトライ削減**: 86%削減（v0.2: 1.17回 → v0.3: 0.17回）
2. **「Forced Cheerfulness」解消**: 中立的発話が自然にPASS
3. **明確な違反検出**: 「だよ」等のキャラ逸脱を正確に検出
4. **テスト品質**: 95%カバレッジ達成

### v0.2からの累積改善

| 改善 | v0.1→v0.2 | v0.2→v0.3 | 累積 |
|------|-----------|-----------|------|
| リトライ削減 | -89% | -86% | **-98.5%** |
| 「姉様」誤用 | 解消 | 維持 | **解消** |
| 口調スコア問題 | 未解消 | **解消** | **解消** |

### 推奨アクション

| 優先度 | アクション | 理由 |
|--------|-----------|------|
| 高 | v0.3を正式採用 | 目標達成、問題解消 |
| 中 | 設定ファイル外部化 | Phase 2終了時に実施 |
| 低 | 追加違反パターン検討 | 運用データに基づき拡充 |

---

## 8. 不採用応答サンプル（全件）

### emotional_support Run 1, Turn 2

**あゆ Attempt 1** ❌
```
Response: *少し顔を赤らめて* 「…まあ、ちょっとね。でも、プロジェクトの進捗もあるから、気をつけてるつもりだよ。」
Checker: tone_check
Reason: 役割違反: あなたは「あゆ」（妹 (Younger Sister)）です。禁止された語尾「だよ」を使用しました。
Suggestion: カジュアルな語尾（だよ）は禁止です。丁寧語で話してください。
```

**あゆ Adopted** ✅
```
Response: *少し顔を赤らめて* 「はい…少しだけ。でも、姉様のおかげでなんとかやってます…ありがとうね。」
```

---

*Generated by duo-talk-evaluation v0.3 analysis framework*
