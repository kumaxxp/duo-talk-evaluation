# プロンプト構造比較: Layered vs Simple vs SillyTavern

**実験ID**: exp_prompt_comparison_001
**実行日時**: 2026-01-21T21:52:54.558798

---

## 1. 実験概要

### 1.1 バリエーション

| バリエーション | LLM | プロンプト構造 | RAG | Director |
|---------------|-----|---------------|-----|----------|
| layered | ollama/swallow-8b | layered (XML階層) | ❌ | ❌ |
| simple | ollama/swallow-8b | simple (フラット+制約) | ❌ | ❌ |
| sillytavern | ollama/swallow-8b | sillytavern (Character Card V2) | ❌ | ❌ |

**注意**: 設定ではGemma3 12Bを指定していたが、実際にはSwallow 8Bが使用された（設定読み込みのバグ）。

### 1.2 シナリオ

| シナリオ | プロンプト | ターン数 |
|---------|-----------|---------|
| casual_greeting | おはよう、二人とも | 5 |
| emotional_support | 最近疲れてるんだ... | 6 |
| topic_exploration | 最近のAI技術について話して | 8 |

---

## 2. 結果サマリー

- 総実行数: 9
- 成功数: 9

### 2.1 バリエーション別スコア

| バリエーション | 成功率 | 平均スコア |
|---------------|--------|-----------|
| layered | 100% | 0.433 |
| simple | 100% | 0.440 |
| sillytavern | 100% | 0.300 |

### 2.2 シナリオ別スコア比較

| シナリオ | layered | simple | sillytavern |
|---------|---------|--------|-------------|
| casual_greeting | 0.540 | 0.520 | 0.400 |
| emotional_support | 0.320 | 0.550 | 0.300 |
| topic_exploration | 0.440 | 0.250 | 0.200 |

### 2.3 メトリクス別平均

| メトリクス | layered | simple | sillytavern |
|-----------|---------|--------|-------------|
| character_consistency | 0.333 | 0.233 | 0.133 |
| topic_novelty | 0.500 | 0.333 | 0.567 |
| relationship_quality | 0.533 | 0.700 | 0.500 |
| naturalness | 0.500 | 0.633 | 0.333 |
| concreteness | 0.300 | 0.267 | 0.333 |

---

## 3. 詳細分析

### 3.1 主要な発見

#### 3.1.1 キャラクター一貫性の問題（全構造で共通）

**深刻な問題**: 全てのプロンプト構造で、キャラクター設定（一人称・口調）が無視されている。

| 問題点 | 設定 | 実際の出力 |
|--------|------|-----------|
| やなの一人称 | 「私」 | 使用されていない |
| やなの口調 | 「〜わ」「〜かしら」 | 「〜じゃん」「〜だよ」（あゆの設定と混同） |
| あゆの一人称 | 「あたし」 | 使用されていない |
| あゆの口調 | 「〜だよ」「〜じゃん」 | 敬語（「〜です」「〜ます」） |

**考察**: Swallow 8Bモデルがキャラクター設定を適切に解釈・再現できていない可能性が高い。Few-shotの例文がより重要になる可能性。

#### 3.1.2 空応答の発生

| 構造 | 空応答（"..."）の発生頻度 |
|------|--------------------------|
| layered | 中 (特にtopic_explorationで多発) |
| simple | 低 |
| sillytavern | 高 (casual_greetingで3/5ターン、topic_explorationで6/8ターン) |

**考察**: SillyTavernのプロンプト構造はSwallow 8Bとの相性が悪い。生成が途中で止まってしまう傾向がある。

#### 3.1.3 チャットテンプレートトークンの混入

全ての構造で `<|im_end|>` や `<|im_start|>user` などのトークンが出力に混入。
- これはOllamaの設定またはモデルのチャットテンプレート処理の問題
- 特にlayeredとsimpleで顕著

### 3.2 構造別の特徴

#### Layered (XML階層)
- **強み**: topic_exploration(0.44)で比較的安定
- **弱み**: emotional_support(0.32)で最低スコア
- **特徴**: XML階層構造がモデルにとって複雑すぎる可能性

#### Simple (フラット+制約)
- **強み**: emotional_support(0.55)で最高スコア、relationship_quality(0.70)も最高
- **弱み**: topic_exploration(0.25)で最低スコア、話題が繰り返される
- **特徴**: 感情的なシナリオでは姉妹関係を表現できるが、知識を必要とするシナリオでは限界

#### SillyTavern (Character Card V2)
- **強み**: topic_novelty(0.57)が最高（具体的な情報を提供する傾向）
- **弱み**: 全体的にスコアが低い、特にnaturalness(0.33)
- **特徴**: 会話が途中で止まることが多い、キャラクター設定の反映度が最も低い

---

## 4. 考察

### 4.1 仮説検証結果

| 仮説 | 結果 |
|-----|------|
| duo-talk (layered)はキャラクター一貫性が高い | ❌ 棄却（0.333、期待より低い） |
| duo-talk-simple (simple)は自然さが高い | △ 部分的支持（naturalness 0.633で最高） |
| duo-talk-silly (sillytavern)はシンプルで高品質 | ❌ 棄却（全体スコア最低） |

### 4.2 Phase 0結果との比較

Phase 0では3つのシステムの実際の出力を評価したが、今回はプロンプト構造のみを分離して評価した。

| 比較項目 | Phase 0 | 今回の実験 |
|---------|---------|-----------|
| 最高スコアのシステム | duo-talk-silly (naturalness) | simple (overall) |
| LLM | Swallow 8B, Gemma2 27B | Swallow 8B |
| プロンプト構造の影響 | 不明（変数が複合） | 小〜中程度 |

### 4.3 キャラクター設定の反映問題

今回の実験で最も重要な発見は、**プロンプト構造よりもLLMのキャラクター解釈能力が律速段階になっている**ということ。

どのプロンプト構造を使っても、Swallow 8Bは：
- 一人称を正しく使い分けられない
- 口調を設定通りに再現できない
- キャラクター間の口調が混同する

これは、より大きなモデル（Gemma3 12B, Gemma2 27B）や、より詳細なFew-shot例が必要であることを示唆している。

### 4.4 設定バグの影響

今回の実験では、意図したGemma3 12Bではなく、Swallow 8Bが使用された。この結果、Phase 0と直接比較できる条件になったとも言えるが、Gemma3 12Bでの再実験が望ましい。

---

## 5. 次のステップ

### 5.1 即座に対応すべき項目

1. **設定読み込みバグの修正**: `ollama_model`がvariationから正しく読み込まれるようにする
2. **Gemma3 12Bでの再実験**: 同一条件でモデルを変えて比較

### 5.2 プロンプト構造の改善方向

| 構造 | 改善方向 |
|------|---------|
| layered | XML構造の簡略化、Few-shot例の強化 |
| simple | 制約ルールの明確化、具体的な会話例の追加 |
| sillytavern | stop_sequencesの調整、プロンプトの短縮化 |

### 5.3 追加実験の必要性

1. **LLM × プロンプト構造の交互作用**: 同一プロンプト構造で異なるLLMを比較
2. **Few-shot数の影響**: 3例 vs 5例 vs 7例の比較
3. **RAG有効時の影響**: プロンプト構造 × RAGの交互作用

---

## 6. 結論

**プロンプト構造のみの影響は限定的**であり、**LLMのキャラクター解釈能力が主要なボトルネック**となっている。

Simpleプロンプト構造（duo-talk-simple方式）が最も安定した結果を示したが、SillyTavern方式は今回のLLM（Swallow 8B）との相性が悪く、会話が途切れる問題が頻発した。

今後は：
1. より大きなLLMでの再実験
2. Few-shot例の質と量の最適化
3. キャラクター設定の強制方法（特殊トークン、prefix強制など）の検討

が必要である。

---

*生成日時: 2026-01-21T21:55:00*
