# duo-talk Phase 2 v2.1 Improvement Spec

**Version:** 2.1.0 (Negative-Check Shift)
**Date:** 2026-01-23
**Target:** ToneCheckerロジックの「加点法」から「違反検知型」への移行

---

## 1. 現状の課題と解決方針

### 課題: "Forced Cheerfulness" (強制された元気さ)
`REPORT.md` の分析により、以下の問題が浮き彫りになりました。

1.  **静かな肯定の拒否**: `(心配そうに) 「え？どうしたの？」` のような、マーカー（ね、よ、！）を含まない自然な発話が `score=0` でリジェクトされている。
2.  **感嘆符の弊害**: スコアを稼ぐために `！` を多用すると、やなが「姉」というより「騒がしい子供」のように攻撃的なニュアンスになる。
3.  **判定の矛盾**: 「不自然ではない」出力を弾いてしまい、無駄なレイテンシ（リトライコスト）を支払っている。

### 新方針: Negative Policing (違反検知)
「〜しなさい（Must）」ではなく**「〜してはいけない（Must Not）」**を監視します。

* **変更前 (Positive)**: 「じゃん」「ね」「！」が入っていなければNG。
* **変更後 (Negative)**: **「です・ます」や「姉様」が入っていなければOK。**

---

## 2. 実装詳細 (ToneChecker v2.1)

`duo_talk_director/checkers/tone_checker.py` のロジックを全面的に書き換えます。

### A. やな (Yana) の判定ロジック

「やならしさ」の強制をやめ、「あゆ化（丁寧語）」と「攻撃性」の排除に集中します。

| 判定項目 | ルール | 判定 |
| :--- | :--- | :--- |
| **禁止語尾 (Formal)** | `です`, `ます`, `ございます`, `致します` | **RETRY** |
| **禁止呼称 (Role)** | `姉様`, `お姉ちゃん`, `姉上` | **RETRY** |
| **禁止文字 (Style)** | `！` (連続使用や文末以外の乱用を検知する場合のみ) ※緩和 | WARN |
| **スコア閾値** | **廃止** (0点でも上記違反がなければPASS) | **PASS** |

```python
# 新しい判定ロジック案
def check_yana(text):
    # 1. 丁寧語（あゆ化）の検出
    if re.search(r"(です|ます|ございます)(?=[。、]|$)", text):
        return RETRY, "禁止された丁寧語（です/ます）が含まれています。"

    # 2. 呼称ミス（姉様呼び）の検出
    if "姉様" in text:
        return RETRY, "自分または妹を「姉様」と呼んではいけません。"

    # 3. 過剰な感嘆符（叫びすぎ）の抑制
    if text.count("！") > 3:
        return WARN, "感嘆符が多すぎます。もう少し落ち着いてください。"
        
    # 違反がなければ、マーカーがなくても合格
    return PASS

```

### B. あゆ (Ayu) の判定ロジック

あゆに関しても、「毒舌マーカー」を必須とするのではなく、「崩れた口調」を禁止します。

| 判定項目 | ルール | 判定 |
| --- | --- | --- |
| **禁止語尾 (Casual)** | `だね`, `だよ`, `じゃん`, `でしょ` | **RETRY** |
| **禁止呼称 (Role)** | `姉上`, `お姉ちゃん`, `やなちゃん` | **RETRY** |
| **禁止スラング** | `マジ`, `ヤバい`, `うける` | **RETRY** |
| **スコア閾値** | **廃止** | **PASS** |

---

## 3. プロンプト調整 (v3.8.2)

Directorのチェックが「減点法」になる分、プロンプト側でキャラクターの「味付け」を担保する必要があります。`!` に頼らない表現をFew-shotに追加します。

### System Prompt (JSON)

```json
"characters": {
  "yana": {
    "speech_style": "砕けた口調だが、乱暴ではない。感嘆符（！）は使いすぎず、語尾の「～」や「ね」で柔らかさを出す。",
    "forbidden_style": ["丁寧語（です/ます）", "攻撃的な大声（！！！）", "姉様呼び"]
  }
}

```

### Few-shot Examples (Adjustment)

`!` を減らし、波ダッシュ `～` や 疑問形 `？` を使った柔らかい例に差し替えます。

* **Before**: `Output: (ガッツポーズをして) 「いいじゃんいいじゃん！あゆ、あとはよろしくね！」`
* **After**: `Output: (にこやかに) 「うん、いいじゃん。面白そうだし、やってみようよ～」`

---

## 4. 期待される効果

1. **リトライ率の最適化**:
* `「うん、わかった」` のような中立的な発言がリトライされなくなるため、無駄な推論コストが削減される。


2. **キャラクターの深度向上**:
* `!` で誤魔化していた「元気キャラ」から脱却し、落ち着いたシーンでは静かに話せるようになる（演技の幅が広がる）。


3. **不自然さの解消**:
* 「毒舌じゃないのに無理やり毒舌を入れる」「元気じゃないのに叫ぶ」といった、Directorによる強要（Over-correction）がなくなる。



## 5. 開発タスクリスト

1. **[Director] ToneChecker改修**:
* ポジティブスコア判定ロジックを削除。
* ネガティブ（禁止ワード/禁止語尾）リストを拡充。


2. **[Core] Prompt v3.8.2作成**:
* やなの `speech_style` 定義から「感嘆符多用」を削除し「柔らかさ」を強調。
* Few-shotデータの微修正。


3. **[Eval] 回帰テスト**:
* これまでリジェクトされていた「静かな会話」がPASSすることを確認。
* 「姉様」呼び等の絶対的な違反が引き続きREJECTされることを確認。

