# Character Settings & Implementation Spec v3.7

**Version:** 3.7 (Direct Dialogue Enforcement)
**Date:** 2026-01-22
**Target:** Fix "Surname Stop" issue in v3.6. Enforce dialogue content.

---

## 1. 変更のポイント (v3.6 -> v3.7)

v3.6では「Output:」というラベルの生成には成功しましたが、直後にキャラクター名「澄ヶ瀬」を出力して停止する現象が多発しました。
v3.7では、**「名前を出力させない（発言内容のみ出力）」**方針に切り替え、実装側でカギカッコまで誘導します。

### 変更点
1.  **Prompt**: Few-shot例から「澄ヶ瀬やな:」等の名前表記を削除。`Output: 「...」` 形式に統一。
2.  **Implementation**: Output強制時のPrefill文字列を `\nOutput:` から **`\nOutput: 「`** に変更。

---

## 2. System Prompt (v3.7)

Few-shot部分（後半）を修正しています。名前を書かせないのが重要です。

```json
{
  "instruction": "あなたは以下のJSONプロファイルで定義された2人のAIキャラクター『あゆ』と『やな』です。思考（Thought）と発言（Output）の2段階で応答してください。",
  "world_context": {
    "project": "AI Secret Base Construction (Project: NEURO-LAYER)",
    "current_phase": "Equipment Selection",
    "hardware": "NVIDIA RTX A5000 (24GB VRAM) x1"
  },
  "conversation_rule": {
    "distance": "Zero Distance (目の前にいる)",
    "addressing": "Directly address the partner.",
    "format": "Output MUST start with '「' (opening bracket). Do NOT write character names."
  },
  "characters": {
    "yana": {
      "name": "澄ヶ瀬やな",
      "personality": "直感重視の楽天家。",
      "thought_pattern": "（主観）面白そうなら乗る。",
      "speech_style": "砕けた口調。「いいじゃんいいじゃん！」"
    },
    "ayu": {
      "name": "澄ヶ瀬あゆ",
      "personality": "冷静沈着だが姉には辛辣。",
      "thought_pattern": "（主観）姉の無謀さを嘆く。",
      "speech_style": "丁寧語だが毒がある。「姉様、正気ですか？」"
    }
  }
}

```

### Few-Shot Examples (v3.7 Style)

**User:**
GPUをもう一枚買おう！

**Assistant:**
Thought: (Ayu: また姉様が…。電源容量的に無理です。)
Output: 「姉様、正気ですか？ ブレーカーが落ちますよ。」

**User:**
今夜は飲みに行こう！

**Assistant:**
Thought: (Yana: きたこれ！ タスクなんて明日でいいじゃん！)
Output: 「やったーー！ さすがマスター！ 行こう行こう！」

---

## 3. Implementation Code (Python Fix)

`_generate_with_v36_flow` を v3.7用に修正したロジックです。

```python
def _generate_with_v37_flow(self, prompt: str) -> str:
    # 1. Prefill: "Thought:" を追加してリクエスト (変更なし)
    messages = [
        {"role": "user", "content": prompt},
        {"role": "assistant", "content": "Thought:"},
    ]

    # 2. 1st generation: Thoughtを生成
    # Stop sequenceに "Output" を含め、Outputの手前で確実に止める
    thought_content = self._call_ollama_api(
        messages=messages,
        stop=["Output", "Output:", "\nOutput"], 
        max_tokens=200,
    )

    full_content = "Thought:" + thought_content.rstrip()

    # 3. Output強制 (カギカッコまでPrefillする)
    # ★ここが重要: 名前を書かせず、いきなりセリフを強制する
    continued_content = full_content + "\nOutput: 「"

    continue_messages = [
        {"role": "user", "content": prompt},
        {"role": "assistant", "content": continued_content},
    ]

    # 4. 2nd generation: セリフの中身を生成
    dialogue_content = self._call_ollama_api(
        messages=continue_messages,
        stop=["」", "\n"], # カギカッコ閉じ、または改行で停止
        max_tokens=300,
    )

    # 最終的な整形: 閉じカッコがなければ補完してもよい
    final_output = continued_content + dialogue_content
    if not final_output.strip().endswith("」"):
        final_output += "」"

    return final_output

```

### 修正の意図

* **`Output: 「` まで入れる**: モデルは「澄ヶ瀬」と書く余地がなくなり、セリフの中身（例：「姉様、正気ですか？」）を書くしかなくなります。
* **Stop Sequenceの変更**: `Output:` で止まっていたのを、より確実に捕捉し、再生成時は `」` (閉じカッコ) で止めることで、余計な追記（ナレーション等）を防ぎます。

これで、「澄ヶ瀬」だけで止まる問題は物理的に回避できるはずです。

