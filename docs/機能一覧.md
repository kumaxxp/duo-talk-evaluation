# duo-talk-ecosystem 機能一覧

**最終更新**: 2026-01-24
**目的**: 実装済み機能の有効/無効状態と効果履歴を一元管理

---

## 凡例

| 状態 | 意味 |
|------|------|
| ✅ 有効 | 現在デフォルトで使用中 |
| ⚡ 利用可能 | 実装済みだが有効化が必要 |
| 🔧 オプション | 設定で切り替え可能 |
| 📦 レガシー | 過去版、互換性のため保持 |

| 効果 | 意味 |
|------|------|
| ⭐⭐⭐ | 大幅改善（検証済み） |
| ⭐⭐ | 中程度改善 |
| ⭐ | 軽微な改善 |
| ❓ | 未検証 |
| ⚠️ | 効果なし/悪化 |

---

## 1. duo-talk-core: 対話生成エンジン

### 1.1 生成モード (GenerationMode)

| 機能 | 状態 | 効果 | 有効化方法 | 概要 |
|------|------|------|-----------|------|
| **TWO_PASS** (v2.4) | ✅ **デフォルト** | ⭐⭐⭐ | デフォルト | ThoughtとOutputを別々に生成。Instruction saturation回避 |
| **ONE_PASS** (v3.8.1) | ⚡ 利用可能 | ⭐⭐ | `generation_mode=GenerationMode.ONE_PASS` | Thought+Outputを1回のLLM呼び出しで生成。Prefill使用 |

**ファイル**: [dialogue_manager.py](../../../duo-talk-core/src/duo_talk_core/dialogue_manager.py)

**効果検証** (2026-01-24):
- TWO_PASSモードにより、Thoughtフォーマット違反が88%減少
- DirectorHybridの評価スコアが+29%向上

---

### 1.2 Two-Pass Generator バージョン履歴

| バージョン | 状態 | 効果 | 改良内容 |
|-----------|------|------|----------|
| v2.4 | 📦 | ⭐⭐⭐ | Two-Pass基本アーキテクチャ |
| v2.5 | 📦 | ⭐⭐ | Translator Pattern（思考→発話変換） |
| v2.6 | 📦 | ⭐⭐ | Enhanced Translator（状況コンテキスト追加） |
| v2.7 | 📦 | ⭐⭐ | Emotional Anchoring（心理的安定性） |
| v2.7.1 | ✅ 累積 | ⭐⭐⭐ | max_tokens=120制限（ヤンデレ現象防止） |
| v2.8 | ✅ 累積 | ⭐ | YAMLプロンプト外部化 |
| v2.9.1 | ✅ 累積 | ⭐⭐ | Anti-Regression、一人称制約 |
| v2.9.2 | ✅ 累積 | ⭐⭐ | Novelty Enforcement、表現多様性 |
| v2.9.3 | ✅ 累積 | ⭐⭐ | Anti-Concierge（敬語禁止） |

**ファイル**: [two_pass_generator.py](../../../duo-talk-core/src/duo_talk_core/two_pass_generator.py)

**重要な発見**:
- v2.7.1の`max_tokens=120`制限が「ヤンデレ現象」（繰り返し、執着的思考）を効果的に防止
- v2.9.3のforbidden_words制約がAI的な丁寧語（「承知いたしました」等）を抑制

---

### 1.3 Two-Phase Engine (v4.0)

| 機能 | 状態 | 効果 | 概要 |
|------|------|------|------|
| **Two-Phase Engine** | ⚡ 隔離実験枠 | ⭐⭐ | Phase1=Thoughtのみ（最小プロンプト）、Phase2=発話生成 |

**ファイル**: [two_phase_engine.py](../../../duo-talk-core/src/duo_talk_core/two_phase_engine.py)

**設計思想**:
- ChatGPTの「Instruction Saturation」分析に基づく
- Phase1では制約なし、Phase2でThoughtを入力として使用
- TWO_PASSとの違い: プロンプト構造がより分離されている

**比較実験結果** (2026-01-24):

| 指標 | TWO_PASS | Two-Phase | 評価 |
|------|----------|-----------|------|
| フォーマット成功率 | 100% | 100% | 同等 |
| avg_thought_length | **85文字** | 54文字 | TWO_PASS優位 |
| Thoughtの性質 | 内面モノローグ寄り | 行動計画寄り | 用途が異なる |

**用途区分**:

| モード | 用途 | 理由 |
|--------|------|------|
| **TWO_PASS** | 本番会話・没入感重視 | Thoughtが内面的で安定 |
| **Two-Phase** | State抽出実験・Action検証 | 制御しやすいが暴れやすい |

> **判断**: 統合しない。両者は「思想」が違う。

---

### 1.4 プロンプトエンジン

| バージョン | 状態 | 効果 | 概要 |
|-----------|------|------|------|
| v3.8.1 (Layered) | ✅ 有効 | ⭐⭐ | XML階層構造、Two-stage flow |
| v0.2 (Hardening) | 📦 | ⭐ | セキュリティ強化版 |

**ファイル**: [prompt_engine.py](../../../duo-talk-core/src/duo_talk_core/prompt_engine.py)

---

## 2. duo-talk-director: 品質制御

### 2.1 Directorタイプ

| 機能 | 状態 | 効果 | 有効化方法 | 概要 |
|------|------|------|-----------|------|
| **DirectorMinimal** (v2.3) | ✅ 有効 | ⭐⭐ | デフォルト | 静的パターンマッチングのみ（高速） |
| **DirectorLLM** (v2.2) | ⚡ 利用可能 | ⭐⭐ | `DirectorLLM(llm_client)` | LLM 5軸評価のみ |
| **DirectorHybrid** (v2.2) | ⚡ 利用可能 | ⭐⭐⭐ | `DirectorHybrid(llm_client)` | 静的チェック + LLM評価の組み合わせ |

**ファイル**:
- [director_minimal.py](../../../duo-talk-director/src/duo_talk_director/director_minimal.py)
- [director_llm.py](../../../duo-talk-director/src/duo_talk_director/director_llm.py)
- [director_hybrid.py](../../../duo-talk-director/src/duo_talk_director/director_hybrid.py)

**DirectorHybridの役割定義**:

> DirectorHybridは**失敗例収集器**である。

| 用途 | 説明 |
|------|------|
| ✅ バッチ評価 | 夜間実行、大量評価 |
| ✅ 実験・A/Bテスト | 比較実験、効果検証 |
| ✅ CI/CDチェック | パイプライン品質確認 |
| ❌ 本番リアルタイム | LLM呼び出しでレイテンシ増（1-3秒） |

**理由**: 本番での生成停止役はDirectorMinimalで十分。Hybridは「どこが悪かったか」を収集する役割。

---

### 2.2 静的チェック

| チェック | 状態 | 効果 | 概要 |
|---------|------|------|------|
| **ThoughtChecker** | ✅ 有効 | ⭐⭐⭐ | Thought構造検証（存在/空/切断チェック） |
| **ToneChecker** (v2.2) | ✅ 有効 | ⭐⭐ | キャラクター口調違反検出（Output部分のみチェック） |
| **ActionSanitizer** (v1.0) | ⚡ 利用可能 | ⭐⭐ | Propsハルシネーション防止（眼鏡・コーヒー等） |
| **PraiseChecker** | ✅ 有効 | ⭐ | あゆの過度な褒め言葉検出 |
| **SettingChecker** | ✅ 有効 | ⭐⭐ | 姉妹関係設定の一貫性チェック |
| **ContextChecker** | ✅ 有効 | ⭐ | ハルシネーション検出 |
| **FormatChecker** | ✅ 有効 | ⭐ | 応答形式（行数）チェック |

**ファイル**: [checks/](../../../duo-talk-director/src/duo_talk_director/checks/)

**ActionSanitizer詳細** (v1.0 - 2026-01-24追加):

Sceneに存在しないpropsをAction内で使用した場合、削除または汎用動作に置換。

| 動作 | 例 |
|------|-----|
| 置換 | `（コーヒーを飲む）` → `（一息つく）` |
| 置換 | `（眼鏡を直す）` → `（目を細める）` |
| 削除 | props置換不可時は台詞のみ残す |

```python
from duo_talk_director.checks import ActionSanitizer

sanitizer = ActionSanitizer()
result = sanitizer.sanitize(output_text, scene_items=["テーブル", "椅子"])
# result.sanitized_text: サニタイズ後のテキスト
# result.blocked_props: ブロックされたprops一覧
```

---

### 2.3 チェッカーオプション

| オプション | 現在の状態 | デフォルト値 | 効果 | 概要 |
|-----------|-----------|------------|------|------|
| `strict_thought_check` | ✅ **有効** | `True` | ⭐⭐⭐ | 空/不正Thoughtでリトライ強制 |
| `skip_llm_on_static_retry` | ✅ **有効** | `True` | ⭐⭐ | 静的RETRY時にLLM評価スキップ |
| `min_thought_length` | ✅ **有効** | `3` | ⭐ | Thoughtの最小文字数 |

**詳細説明**:

| オプション | `True`の動作 | `False`の動作 | 推奨 |
|-----------|-------------|--------------|------|
| `strict_thought_check` | 空Thought → RETRY | 空Thought → WARN（通過） | ✅ True推奨 |
| `skip_llm_on_static_retry` | 静的NG時LLMスキップ（高速） | 常にLLM評価（高コスト） | ✅ True推奨 |

**効果検証** (2026-01-24):
- `strict_thought_check=True`により、`(`のみのThought等の誤通過が0に
- ToneChecker v2.2により、Thought内の「姉様」誤検出が解消

**変更方法**:
```python
# strict_thought_checkを無効にする場合
director = DirectorMinimal(strict_thought_check=False)

# skip_llm_on_static_retryを無効にする場合
director = DirectorHybrid(llm_client, skip_llm_on_static_retry=False)
```

---

### 2.4 LLM評価 5軸スコア

| 軸 | 重み | 概要 |
|----|------|------|
| character_consistency | 0.25 | キャラクター一貫性 |
| topic_novelty | 0.20 | 話題の新規性 |
| relationship_quality | 0.25 | 姉妹関係の表現 |
| naturalness | 0.15 | 会話の自然さ |
| concreteness | 0.15 | 情報の具体性 |

**閾値設定** ([thresholds.py](../../../duo-talk-director/src/duo_talk_director/config/thresholds.py)):
- RETRY閾値: overall < 0.4, character < 0.3, relationship < 0.3
- WARN閾値: overall < 0.6

---

## 3. duo-talk-evaluation: 評価・実験

### 3.1 評価器タイプ

| 評価器 | 状態 | 効果 | 概要 |
|-------|------|------|------|
| **DialogueEvaluator** (Gemini) | ✅ 有効 | ⭐⭐⭐ | gemini-2.5-flash使用、高精度 |
| **OllamaEvaluator** | ⚡ 利用可能 | ⭐⭐ | gemma3:12b使用、ローカル実行 |
| **LocalLLMEvaluator** | ⚡ 利用可能 | ❓ | 任意のローカルLLM |

**ファイル**: [src/evaluation/](../src/evaluation/)

---

### 3.2 プロンプト構造タイプ

| タイプ | 現在の状態 | 効果 | 概要 | 使用場所 |
|--------|-----------|------|------|---------|
| **LAYERED** (v3.8.1) | ✅ **本番使用中** | ⭐⭐ | XML階層構造 | duo-talk-core |
| **JSON** (v3.3+) | ⚡ 実験用 | ⭐⭐ | JSON Schema形式 | evaluation実験 |
| **SIMPLE** | ⚡ 実験用 | ⭐ | テキストのみ | 比較実験用 |
| **SILLYTAVERN** | ⚡ 実験用 | ❓ | ST互換形式 | 外部ツール連携 |

**詳細比較**:

| 特徴 | LAYERED | JSON | SIMPLE |
|------|---------|------|--------|
| 構造化 | XML階層 | JSON Schema | プレーンテキスト |
| キャラ定義 | 詳細 | 詳細 | 簡潔 |
| Few-shot例 | あり | あり | 最小限 |
| 世界観設定 | あり | あり | なし |
| 推奨用途 | **本番環境** | A/Bテスト | ベースライン |

**推奨**: 本番環境では **LAYERED (v3.8.1)** を使用。実験では比較対象として他のタイプも使用可能。

---

### 3.3 プロンプト版詳細 (A/Bテスト用)

| バージョン | 現在の状態 | 効果 | 核心コンセプト |
|-----------|-----------|------|---------------|
| v3.0-v3.2 | 📦 レガシー | ⭐ | 初期実装 |
| v3.3 | 📦 レガシー | ⭐⭐ | JSON Schema形式導入 |
| v3.4 | 📦 レガシー | ⭐⭐ | Sandwich Instruction |
| v3.5 | 📦 レガシー | ⭐⭐ | Response Protocol追加 |
| **v3.6** | ⚡ 利用可能 | ⭐⭐ | System-Assisted Output Enforcement |
| **v3.7** | ⚡ 利用可能 | ⭐⭐ | Direct Dialogue Enforcement |
| **v3.8** | ⚡ 利用可能 | ⭐⭐⭐ | Narrative Restoration |

#### v3.6: System-Assisted Output Enforcement

**核心**: 「プロンプトで思考を誘発し、**システム実装で発話を強制**する」

```
変更点:
- CRITICAL INSTRUCTION削除（実装側で担保）
- response_protocol削除（実装側で担保）
- シンプルなJSON構造

実装方式:
- Prefill + Continue Generation
- LLMに "Thought:" まで入力し、続きを生成させる
```

**メリット**: プロンプトの複雑さを減らしつつフォーマット遵守
**デメリット**: Prefill対応のLLMバックエンドが必要

#### v3.7: Direct Dialogue Enforcement

**核心**: 「**名前を出力させない**（発言内容のみ出力）」

```
変更点:
- Few-shot例から名前表記を削除
- `Output: 「...」` 形式に統一
- format指示追加

実装方式:
- `Output: 「` までPrefill
- 名前なしで発言のみ出力
```

**メリット**: キャラ名の誤出力を防止
**デメリット**: 動作描写（*ため息*など）が出力されにくい

#### v3.8: Narrative Restoration

**核心**: 「**動作描写を許可**しつつ、名前は後処理で削除」

```
変更点:
- Few-shot例に動作描写を追加
- `(Action) 「Dialogue」` 形式を許可
- 名前は後処理でクリーニング

実装方式:
- 動作描写付き出力を許可
- 正規表現で名前部分を除去
```

**メリット**: 自然な動作描写と発話の両立
**デメリット**: 後処理が必要

#### 推奨バージョン

| ユースケース | 推奨 | 理由 |
|-------------|------|------|
| **本番環境** | duo-talk-core (LAYERED v3.8.1) | 安定性・検証済み |
| **表現力重視** | v3.8 | 動作描写が自然 |
| **フォーマット厳密** | v3.7 | 名前誤出力なし |
| **シンプル実装** | v3.6 | プロンプト簡素化 |

**有効化方法**:
```python
from experiments.ab_test.config import VariationConfig

config = VariationConfig(
    use_v36_flow=True,  # v3.6: Prefill方式
    use_v37_flow=True,  # v3.7: 名前なし出力
    use_v38_flow=True,  # v3.8: 動作描写許可
)
```

**ファイル**:
- [json_v36.py](../experiments/ab_test/prompts/json_v36.py)
- [json_v37.py](../experiments/ab_test/prompts/json_v37.py)
- [json_v38.py](../experiments/ab_test/prompts/json_v38.py)

---

### 3.4 実験設定オプション

| オプション | 状態 | デフォルト | 概要 |
|-----------|------|----------|------|
| `rag_enabled` | 🔧 | False | RAG統合（Phase 3予定） |
| `director_enabled` | 🔧 | False | Director品質制御 |
| `few_shot_count` | 🔧 | 3 | Few-shotサンプル数 |
| `max_sentences` | 🔧 | 3 | 最大文数制限 |
| `temperature` | 🔧 | 0.7 | 生成温度 |

---

## 4. 重要な設定値

### 4.1 推奨パラメータ

| パラメータ | 推奨値 | 理由 |
|-----------|--------|------|
| Temperature | 0.7 | 創造性と一貫性のバランス |
| max_tokens (Thought) | 120 | ヤンデレ現象防止 (v2.7.1) |
| max_tokens (Output) | 300 | 適切な応答長 |
| max_retries | 3 | リトライ上限 |

### 4.2 Director閾値

| 閾値 | 値 | 動作 |
|------|-----|------|
| retry_overall | 0.4 | 全体スコア<0.4でRETRY |
| retry_character | 0.3 | キャラ一貫性<0.3でRETRY |
| warn_overall | 0.6 | 全体スコア<0.6でWARN |

---

## 5. 機能組み合わせの推奨

### 5.1 高品質対話（推奨構成）

```python
from duo_talk_core import create_dialogue_manager, GenerationMode
from duo_talk_director import DirectorHybrid

manager = create_dialogue_manager(
    backend="ollama",
    model="gemma3:12b",
    generation_mode=GenerationMode.TWO_PASS,  # Instruction saturation回避
    director=DirectorHybrid(llm_client),       # 静的+LLM評価
    max_retries=3,
    temperature=0.7,
)
```

### 5.2 高速対話（パフォーマンス重視）

```python
from duo_talk_core import create_dialogue_manager, GenerationMode
from duo_talk_director import DirectorMinimal

manager = create_dialogue_manager(
    backend="ollama",
    model="gemma3:12b",
    generation_mode=GenerationMode.ONE_PASS,  # 1回のLLM呼び出し
    director=DirectorMinimal(),                # 静的チェックのみ
    max_retries=2,
)
```

---

## 6. 設計原則

### 6.1 Thought評価の原則

> **Thoughtの長さは品質指標ではない。**
> **Thoughtの"役割"が異なるため、生成モードごとに最適値が存在する。**

| 誤解 | 正しい理解 |
|------|-----------|
| ❌「短い＝悪い」 | ○ 短くても行動計画として適切なら良い |
| ❌「長い＝良い」 | ○ 長くても冗長なら問題 |

### 6.2 Director設計原則

| 原則 | 説明 |
|------|------|
| **DirectorMinimalが本番** | 高速な静的チェックで十分 |
| **DirectorHybridは収集器** | 「どこが悪かったか」を知るため |
| **LLMスキップ優先** | 静的RETRYならLLM評価は不要 |

### 6.3 モード分離原則

| 原則 | 説明 |
|------|------|
| **TWO_PASSが主軸** | 本番対話はこちら |
| **Two-Phaseは隔離** | 実験・State抽出専用 |
| **統合しない** | 思想が異なるため |

---

## 7. 未検証・今後の検討事項

| 機能 | 状態 | 検討事項 |
|------|------|---------|
| Two-Phase Engine (v4.0) | ✅ 検証済み | 隔離実験枠として運用 |
| RAG統合 | 🔧 未実装 | Phase 3で実装予定 |
| v3.6-v3.8フロー | ⚡ 部分検証 | 本番環境での効果検証が必要 |
| KoboldCPP対応 | ⚡ 実装済み | 実際の使用実績なし |
| State Updater | 🔧 未実装 | Thought再利用ログ蓄積後に判断 |

---

## 8. 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2026-01-24 | 初版作成 |
| 2026-01-24 | TWO_PASSモード効果検証追加 |
| 2026-01-24 | ToneChecker v2.2（Thought除外）追加 |
| 2026-01-24 | ActionSanitizer v1.0（Propsハルシネーション防止）追加 |
| 2026-01-24 | DirectorHybrid役割定義（失敗収集器）追加 |
| 2026-01-24 | TWO_PASSをデフォルト化（Phase 2.2.1） |
| 2026-01-24 | Two-Phase Engine比較実験結果を反映（隔離実験枠として確定） |
| 2026-01-24 | 設計原則セクション追加（Thought評価、Director設計、モード分離） |
| 2026-01-24 | StateExtractor v1.0追加（Thought状態抽出、34テスト、97%カバレッジ） |
| 2026-01-24 | CI/CDスクリプト整理（Makefile、run_tests.py、run_experiments.py） |

---

*このドキュメントはduo-talk-evaluation実験ハブで管理されています*
