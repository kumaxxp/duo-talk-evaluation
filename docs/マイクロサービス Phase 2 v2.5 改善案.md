# duo-talk Phase 2 v2.5 Improvement Spec

**Version:** 2.5.0 (Two-Pass Refinement)
**Date:** 2026-01-23
**Target:** Two-Pass生成時の「言葉遣いの乱暴さ」と「冗長な復唱」を解消し、Gemma 3の表現力を最大化する。

---

## 1. 課題の再定義

レポート `two_pass_comparison_20260123_171428.md` から、現在のTwo-Pass実装（v2.4）には以下の問題があります。

1.  **Parroting (オウム返し)**:
    * 思考で「怖いって言ってるじゃん」と考えると、発話もそのまま「怖いって言ってるじゃん！」になる。
    * 原因: 2回目のプロンプトで「思考に基づいて話せ」としか指示していないため、モデルが「思考を読み上げるタスク」だと誤解している。
2.  **Style Mismatch (口調の崩壊)**:
    * 思考テキスト（独り言）は乱暴になりがちだが、それがそのまま発話に漏れ出し、キャラクターの本来の口調（丁寧語など）が失われている。

---

## 2. 改善方針: "Translator Pattern" (翻訳者パターン)

Step 2（発話生成）の役割を「思考の出力」から**「思考の翻訳（Style Transfer）」**へと再定義します。

* **Before**: 「思考：『姉様バカじゃないの』 -> 発言して」
* **After**: 「思考：『姉様バカじゃないの』 -> **これを『澄ヶ瀬あゆ』の口調（丁寧だが毒舌）に変換して相手に伝えて**」

---

## 3. 実装詳細

`duo_talk_core/dialogue_manager.py` 内の `_generate_two_pass` メソッドで構築する **Step 2 (Speaker) 用プロンプト** を大幅に強化します。

### A. System Prompt for Speaker (Step 2)

```python
def _construct_speaker_prompt(self, character, thought_content, user_input):
    return f"""
    あなたは{character.name}としてロールプレイを行ってください。
    
    # あなたのプロフィール
    {character.profile_json}  <-- ここにJSON定義を再注入し、口調を思い出させる
    
    # 現在の状況
    ユーザーの発言: "{user_input}"
    あなたの内面（本音）: "{thought_content}"
    
    # 重要: 出力指示
    あなたの「内面」はあくまで独り言です。これをそのまま読み上げないでください。
    内面の内容を、**キャラクター設定（speech_style）に忠実なセリフ**に変換して出力してください。
    
    - 思考の内容を要約したり、説明したりしないこと。
    - 相手（ユーザーや姉妹）に話しかける自然なセリフにすること。
    - 形式: (Action) 「Dialogue」
    """

```

### B. Few-shot for Speaker (Step 2)

Step 2専用のFew-shotを用意し、「思考（乱暴）→ 発話（丁寧）」の変換例を提示します。これがないとモデルは変換ルールを理解できません。

```json
[
  {
    "input_thought": "姉様またバカなこと言ってる…。電源容量足りないって何度言えばわかるの？呆れるわ。",
    "output_speech": "*ため息をついて* 「姉様、何度言えば理解していただけるのですか？ 電源容量が不足しています。」"
  },
  {
    "input_thought": "うわ、すごいニュース！これ絶対バズるやつじゃん！早くあゆに教えなきゃ！",
    "output_speech": "(目を輝かせて) 「ねえあゆ！ 見て見てこれ！ 絶対流行るやつだよ～！」"
  }
]

```

---

## 4. 期待される効果

| 課題 | v2.4 (現状) | v2.5 (改善後) | 理由 |
| --- | --- | --- | --- |
| **口調の乱れ** | 思考の口調が漏れる | **設定通りの口調** | JSONプロファイルを再提示し、変換を明示するため。 |
| **冗長な復唱** | 思考を繰り返す | **自然な対話** | 「読み上げるな」「変換せよ」と指示するため。 |
| **コンテキスト** | 不足疑い | **十分** | プロンプト改良で解決するため、ウィンドウ拡張は不要。 |

---

## 5. 開発タスクリスト

1. **[Core] Speakerプロンプト改修**:
* `_construct_speaker_prompt` を実装し、JSONプロファイルと変換指示を埋め込む。


2. **[Core] Speaker用Few-shot実装**:
* `thought` -> `speech` の変換例（3件程度）を動的に挿入するロジックを追加。


3. **[Eval] Two-Pass検証**:
* 再度 `two_pass_comparison` を実行し、今度は「口調が丁寧になっているか」「思考をそのまま言っていないか」を確認する。


