# 仕様書: 2フェーズ生成アーキテクチャ

**文書ID**: 20260124_001
**作成日**: 2026-01-24
**フェーズ**: Phase 3（提案）
**ステータス**: Draft
**情報源**: ChatGPT分析

---

## 概要

現行の1プロンプト生成から、Thought生成（Phase 1）とSpeech/Action生成（Phase 2）を分離する2フェーズアーキテクチャへの移行提案。

---

## 背景と目的

### 現状の問題

DirectorHybrid導入による実験結果（2026-01-24）から以下が判明：

| 観測事項 | 詳細 |
|----------|------|
| Thought欠落パターン | `Thought: (\nOutput: ...` が同一ターンで3回連続発生 |
| 原因 | モデル（gemma3:12b）の **Instruction飽和** |
| 症状 | Thoughtを書く状態に入れていない |

### Instruction飽和の原因

1. Thought と Output を同一プロンプトで強制
2. 出力フォーマットが複雑（行動記法・例文・禁止事項が多い）
3. DirectorHybrid がさらに「評価文脈」を重ねている

### 現行リトライの限界

> リトライは「賭け直し」
> 今起きているのは「賭場が壊れている」

- リトライ導入は症状を和らげただけ
- Thought欠落の構造的原因は残存

---

## 詳細仕様

### 提案アーキテクチャ

```
┌─────────────────────────────────────────────────────────┐
│                    2フェーズ生成                         │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  ┌─────────────────┐    ┌─────────────────────────┐    │
│  │   Phase 1       │    │      Phase 2            │    │
│  │  Thought生成    │ →  │   Speech/Action生成     │    │
│  │                 │    │                         │    │
│  │ - Thoughtのみ   │    │ - Thoughtを入力として   │    │
│  │ - 50-100 tokens │    │   注入                  │    │
│  │ - 禁止事項なし  │    │ - 行動・台詞・制約     │    │
│  │ - Director不使用│    │ - DirectorHybrid使用   │    │
│  └─────────────────┘    └─────────────────────────┘    │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

### Phase 1: Thought専用生成

| 項目 | 仕様 |
|------|------|
| 出力 | Thoughtのみ |
| トークン数 | 50〜100 tokens |
| プロンプト内容 | キャラクター設定、会話履歴、トピック |
| 除外項目 | 行動記法、台詞、評価、禁止事項 |
| Director | **使用しない** |

**目的**: モデルがThought生成に集中できる環境を提供

### Phase 2: Speech/Action生成

| 項目 | 仕様 |
|------|------|
| 入力 | Phase 1で生成されたThought |
| 出力 | 行動描写 + 台詞 |
| プロンプト内容 | Thought + 行動・台詞制約 + Scene制約 |
| Director | DirectorHybrid使用可 |

**目的**: Thoughtを前提とした表現生成に特化

### Director役割の再定義

| 役割 | 使用タイミング | 備考 |
|------|---------------|------|
| Thoughtチェック | Phase 1後 | 静的ルールのみ |
| 会話品質評価 | Phase 2後 | DirectorHybrid |
| State更新 | 非同期 | 別ターン or バックグラウンド |

---

## 実装要件

### やるべきこと（優先順）

1. **【必須】Thought完全分離**
   - Phase 1専用プロンプト設計
   - 50-100 tokensの軽量生成

2. **【必須】Speech/Action分離**
   - Thoughtを入力として注入
   - DirectorHybridはここで使用

3. **【推奨】Director役割再定義**
   - 万能型から専門型へ

### やってはいけないこと

| NG行動 | 理由 |
|--------|------|
| リトライ回数を増やす | Instruction飽和を悪化 |
| Directorのチェックを増やす | Instruction飽和を悪化 |
| 「もっと厳しくThoughtを書け」と指示 | Instruction飽和を悪化 |

---

## 期待効果

| 指標 | 現状 | 期待値 |
|------|------|--------|
| Thought生成成功率 | 〜70% | 95%+ |
| リトライ回数 | 平均1.0 | 平均0.2以下 |
| 品質スコア | 0.67-0.71 | 0.75+ |

---

## 設計レベルでの結論

> **「1プロンプトで賢くさせる」フェーズは終わり**
> **「工程分離で安定させる」フェーズに入った**

---

## 関連文書

- [PHASE2_DIRECTOR_LLM.md](../phases/) - Phase 2.2 LLM Director仕様
- 実験結果: `results/director_comparison_20260124_103653/`

---

## 変更履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-01-24 | 1.0 | 初版作成（ChatGPT分析に基づく） |

---

*Source: ChatGPT分析（2026-01-24）*
